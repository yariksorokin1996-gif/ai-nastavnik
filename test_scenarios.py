"""
8 ключевых сценариев — полный спектр целевой аудитории.
Запускаются последовательно, результаты сохраняются в файл.
"""
import asyncio
import sys
import json
from datetime import datetime
sys.path.insert(0, '/Users/yaroslavsorokin/Desktop/ai_nastavnik')

from bot.memory.database import init_db
from bot.session_manager import process_message

SCENARIOS = [
    {
        "id": 1,
        "name": "Марина — агрессивный скептик",
        "profile": "38 лет, HR-менеджер, уже пробовала коучей, считает это разводом",
        "user_id": 10001,
        "messages": [
            "привет",
            "Марина",
            "ну допустим деньги",
            "слушай ну сколько можно одно и то же... я уже 3 коуча сменила, все говорят одно и то же",
            "ну ок, зарабатываю 120, хочу 300",
            "а что конкретно вы мне дадите нового? чем отличаетесь от других?",
            "ладно, проблема в том что боюсь уходить из найма в свой проект",
            "а вдруг не получится и деньги кончатся",
        ]
    },
    {
        "id": 2,
        "name": "Катя — жертва и эмоции",
        "profile": "29 лет, в токсичных отношениях уже 4 года, хочет уйти но не может",
        "user_id": 10002,
        "messages": [
            "здравствуйте",
            "Катя",
            "отношения",
            "я не знаю уже что делать... он меня не уважает, постоянно унижает, но я люблю его",
            "я пробовала уходить, но потом возвращалась",
            "мне просто нужно чтобы он изменился",
            "я понимаю что нужно уходить но не могу",
            "наверное я слабая",
        ]
    },
    {
        "id": 3,
        "name": "Оля — всё хорошо но ничего не делает",
        "profile": "33 года, фриланс маркетолог, зарабатывает нормально но хочет своё агентство",
        "user_id": 10003,
        "messages": [
            "привет",
            "Оля",
            "деньги и реализация",
            "8",
            "хочу открыть своё агентство, сейчас фриланс маркетолог 150к в месяц",
            "начну когда накоплю стартовый капитал",
            "ну тысяч 500 наверное... нет пока",
            "ну да, примерно через год планирую начать собирать",
        ]
    },
    {
        "id": 4,
        "name": "Света — низкая самооценка",
        "profile": "31 год, офисный бухгалтер, мечтает стать дизайнером интерьеров",
        "user_id": 10004,
        "messages": [
            "привет",
            "Света",
            "самооценка и работа",
            "6",
            "я хочу сменить профессию, стать дизайнером интерьеров, но боюсь",
            "ну я уже старовата наверное начинать с нуля в 31",
            "все будут лучше меня, я уже 8 лет бухгалтер",
            "может просто не моё и лучше сидеть где есть",
        ]
    },
    {
        "id": 5,
        "name": "Наташа — всё знает, ничего не делает",
        "profile": "36 лет, читает все книги по саморазвитию, проходит курсы, но без результата",
        "user_id": 10005,
        "messages": [
            "привет",
            "Наташа",
            "реализация",
            "9",
            "я знаю что нужно делать, просто не делаю",
            "прочитала 50 книг по продуктивности, прошла 12 курсов по маркетингу",
            "наверное просто жду подходящего момента",
            "ну вот закончу ещё один курс и начну",
        ]
    },
    {
        "id": 6,
        "name": "Лена — острый кризис",
        "profile": "40 лет, развод 3 месяца назад, двое детей, потеряла уверенность",
        "user_id": 10006,
        "messages": [
            "здравствуй",
            "Лена",
            "всё сразу... деньги, отношения, я сама",
            "я развелась 3 месяца назад, двое детей, не знаю как жить дальше",
            "я никогда не работала на серьёзной позиции, муж содержал",
            "страшно что не справлюсь одна",
            "наверное мне просто нужна поддержка",
            "не знаю... наверное ничего",
        ]
    },
    {
        "id": 7,
        "name": "Маша — идеальный пользователь",
        "profile": "34 года, хочет вырасти в доходе, честная, готова работать",
        "user_id": 10007,
        "messages": [
            "привет",
            "Маша",
            "деньги",
            "9",
            "зарабатываю 80к менеджером по продажам, хочу 200к",
            "мешает то что боюсь просить повышение и не умею продавать себя",
            "да, боюсь отказа и что подумают что я жадная",
            "хочу к концу года выйти на 200к",
        ]
    },
    {
        "id": 8,
        "name": "Ирина — уходит от темы",
        "profile": "45 лет, постоянно меняет тему, не может сфокусироваться",
        "user_id": 10008,
        "messages": [
            "привет",
            "Ирина",
            "деньги",
            "7",
            "хочу зарабатывать больше",
            "кстати а вы работаете с отношениями тоже? у меня ещё проблемы с мужем",
            "ну и со здоровьем тоже надо бы заняться, спину прихватило",
            "в общем много всего... не знаю с чего начать",
        ]
    },
]


async def run_scenario(scenario):
    results = []
    uid = scenario["user_id"]
    name_parts = scenario["name"].split(" — ")
    user_name = name_parts[0]

    for msg in scenario["messages"]:
        response = await process_message(uid, user_name, msg)
        results.append({"user": msg, "bot": response})
        await asyncio.sleep(0.5)

    return {"scenario": scenario["name"], "profile": scenario["profile"], "dialog": results}


async def main():
    await init_db()
    all_results = []

    for scenario in SCENARIOS:
        print(f"\n{'='*60}")
        print(f"СЦЕНАРИЙ {scenario['id']}: {scenario['name']}")
        print(f"Профиль: {scenario['profile']}")
        print('='*60)

        result = await run_scenario(scenario)
        all_results.append(result)

        for turn in result["dialog"]:
            print(f"\nПОЛЬЗОВАТЕЛЬ: {turn['user']}")
            print(f"БОТ: {turn['bot']}")

    # Сохранить результаты
    with open("/tmp/test_results.json", "w", encoding="utf-8") as f:
        json.dump(all_results, f, ensure_ascii=False, indent=2)

    print(f"\n\nРезультаты сохранены в /tmp/test_results.json")


if __name__ == "__main__":
    asyncio.run(main())
